# Koatty æ¡†æ¶å‡çº§ Koa 3.0 å…¼å®¹æ€§åˆ†ææŠ¥å‘Š

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

**ç»“è®ºï¼šâœ… Koatty æ¡†æ¶å¯ä»¥å¹³æ»‘å‡çº§åˆ° Koa 3.0ï¼Œå…¼å®¹æ€§é£é™©è¾ƒä½**

ç»è¿‡å…¨é¢çš„ä»£ç åˆ†æï¼ŒKoatty æ¡†æ¶åŠå…¶æ ¸å¿ƒä¾èµ–åŒ…å·²ç»éµå¾ªäº†ç°ä»£åŒ–çš„å¼€å‘å®è·µï¼Œä¸»è¦ä½¿ç”¨ async/await è¯­æ³•ï¼Œæ²¡æœ‰ä½¿ç”¨ Koa 3.0 ä¸­å·²ç§»é™¤çš„ APIã€‚å‡çº§è¿‡ç¨‹ç›¸å¯¹å¹³æ»‘ï¼Œä¸»è¦éœ€è¦å…³æ³¨ä¾èµ–åŒ…ç‰ˆæœ¬æ›´æ–°å’Œå°‘é‡é…ç½®è°ƒæ•´ã€‚

---

## äºŒã€Koa 3.0 ä¸»è¦å˜æ›´

### 2.1 ç ´åæ€§å˜æ›´

| å˜æ›´é¡¹                        | è¯¦ç»†è¯´æ˜                                                             | Koatty å½±å“                                        |
| ----------------------------- | -------------------------------------------------------------------- | -------------------------------------------------- |
| **ç§»é™¤ Generator æ”¯æŒ**       | Koa 3.0 å®Œå…¨ç§»é™¤å¯¹ `function*` å’Œ `yield` çš„æ”¯æŒï¼Œåªæ”¯æŒ async/await | âœ… **æ— å½±å“** - æ¡†æ¶å·²å…¨é¢ä½¿ç”¨ async/await          |
| **Node.js ç‰ˆæœ¬è¦æ±‚**          | è¦æ±‚ Node.js 18+                                                     | âš ï¸ **éœ€è°ƒæ•´** - å½“å‰è¦æ±‚ >12.0.0ï¼Œéœ€æ›´æ–°åˆ° >=18.0.0 |
| **http-errors å‡çº§åˆ° v2**     | `ctx.throw()` è°ƒç”¨æ ¼å¼å˜åŒ–                                           | âš ï¸ **éœ€å…³æ³¨** - ç”¨æˆ·ä»£ç å¯èƒ½å—å½±å“                  |
| **ç§»é™¤ res.redirect('back')** | ä½¿ç”¨ `ctx.back()` æ›¿ä»£                                               | âœ… **æ— å½±å“** - æ¡†æ¶æœªä½¿ç”¨                          |
| **querystring æ¨¡å—æ›¿æ¢**      | ä½¿ç”¨ URLSearchParams æ›¿ä»£ Node.js querystring                        | âœ… **æ— å½±å“** - ä½¿ç”¨ fast-querystring               |
| **å“åº”ä½“ä¸º null**             | è‡ªåŠ¨è®¾ç½® content-length: 0                                           | âœ… **å‘åå…¼å®¹** - è¡Œä¸ºæ”¹è¿›                          |
| **currentContext API**        | æ–°å¢ `app.currentContext` åŸºäº AsyncLocalStorage                     | â„¹ï¸ **å¯é€‰å¢å¼º** - å¯åˆ©ç”¨æ–°ç‰¹æ€§                      |

### 2.2 å…¶ä»–é‡è¦å˜æ›´

- **æ€§èƒ½ä¼˜åŒ–**: å†…éƒ¨å®ç°ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡çº¦ 5-10%
- **ç±»å‹å®šä¹‰**: æ”¹è¿› TypeScript ç±»å‹å®šä¹‰
- **ä¾èµ–æ›´æ–°**: æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬

---

## ä¸‰ã€æ ¸å¿ƒä¾èµ–åŒ…å…¼å®¹æ€§åˆ†æ

### 3.1 ä¾èµ–æ¶æ„å›¾

```
koatty (v3.13.2)
  â””â”€â”€ koa: ~2.16.2  [éœ€å‡çº§åˆ° ^3.0.0]
  â””â”€â”€ koatty_core (~1.19.0-6)
      â”œâ”€â”€ koa-compose: ^4.1.0  [å…¼å®¹æ€§å¾…ç¡®è®¤]
      â”œâ”€â”€ koatty_container (~1.17.0)  âœ… æ—  Koa ä¾èµ–
      â”œâ”€â”€ koatty_exception (~1.8.0)   âœ… æ— ç›´æ¥ Koa ä¾èµ–
      â”œâ”€â”€ koatty_trace (~1.16.0)      âœ… æ— ç›´æ¥ Koa ä¾èµ–
      â””â”€â”€ koatty_lib, koatty_logger   âœ… æ—  Koa ä¾èµ–
  â””â”€â”€ koatty_serve (~2.9.0-15)
      â””â”€â”€ koatty_core  [é—´æ¥ä¾èµ– Koa]
  â””â”€â”€ koatty_router (1.20.0-8)
      â”œâ”€â”€ @koa/router: ^14.0.0  [å…¼å®¹æ€§å¾…ç¡®è®¤]
      â”œâ”€â”€ koa-compose: ^4.1.0
      â”œâ”€â”€ koa-graphql: ^0.12.0  [å…¼å®¹æ€§å¾…ç¡®è®¤]
      â””â”€â”€ koatty_core
```

### 3.2 å„åŒ…è¯¦ç»†åˆ†æ

#### 3.2.1 koatty_core âš ï¸ **æ ¸å¿ƒä¾èµ–ï¼Œéœ€æ›´æ–°**

**å½“å‰ç‰ˆæœ¬**: 1.19.0-6

**å…³é”®ä»£ç åˆ†æ**:
```typescript
// src/Application.ts
import Koa from "koa";
export class Koatty extends Koa implements KoattyApplication {
  // Koatty ç›´æ¥ç»§æ‰¿ Koa
}
```

**å½±å“è¯„ä¼°**:
- âœ… å·²ä½¿ç”¨ async/awaitï¼Œæ—  Generator
- âœ… æœªä½¿ç”¨å·²ç§»é™¤çš„ API
- âš ï¸ ä¾èµ– `koa-compose: ^4.1.0`
- âš ï¸ `@types/koa` éœ€å‡çº§åˆ° v3

**å‡çº§å»ºè®®**:
1. æ›´æ–° `koa` peerDependency åˆ° `^3.0.0`
2. éªŒè¯ `koa-compose` å…¼å®¹æ€§ï¼ˆå¯èƒ½éœ€è¦å‡çº§ï¼‰
3. æ›´æ–° `@types/koa` åˆ° `^2.15.0` æˆ–æ›´é«˜
4. å‘å¸ƒæ–°ç‰ˆæœ¬ v1.20.x

---

#### 3.2.2 koatty_serve âš ï¸ **é—´æ¥ä¾èµ–ï¼Œéœ€æµ‹è¯•**

**å½“å‰ç‰ˆæœ¬**: 2.9.0-15

**å…³é”®ä»£ç åˆ†æ**:
```typescript
// src/server/http.ts
protected createProtocolServer(): void {
  (this as any).server = createServer((req, res) => {
    this.app.callback()(req, res);  // è°ƒç”¨ Koa callback
  });
}
```

**å½±å“è¯„ä¼°**:
- âœ… ä¸ç›´æ¥ä¾èµ– Koaï¼Œé€šè¿‡ koatty_core é—´æ¥ä½¿ç”¨
- âœ… åªè°ƒç”¨æ ‡å‡† Koa API (`callback()`)
- âœ… å·²ä½¿ç”¨ async/await

**å‡çº§å»ºè®®**:
1. æ›´æ–° koatty_core åˆ°æ”¯æŒ Koa 3 çš„ç‰ˆæœ¬
2. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ŒéªŒè¯æ‰€æœ‰åè®®ï¼ˆHTTP/HTTPS/HTTP2/gRPC/WebSocketï¼‰
3. é‡ç‚¹æµ‹è¯•ä¸­é—´ä»¶å’Œä¸Šä¸‹æ–‡ä¼ é€’

---

#### 3.2.3 koatty_router âš ï¸ **éœ€éªŒè¯ç¬¬ä¸‰æ–¹ä¾èµ–**

**å½“å‰ç‰ˆæœ¬**: 1.20.0-8

**ç¬¬ä¸‰æ–¹ä¾èµ–**:
- `@koa/router: ^14.0.0` - **éœ€ç¡®è®¤ Koa 3 å…¼å®¹æ€§**
- `koa-compose: ^4.1.0` - **éœ€ç¡®è®¤ Koa 3 å…¼å®¹æ€§**
- `koa-graphql: ^0.12.0` - **éœ€ç¡®è®¤ Koa 3 å…¼å®¹æ€§**

**å½±å“è¯„ä¼°**:
- âœ… ä½¿ç”¨ `fast-querystring` è€Œé Node.js querystring
- âš ï¸ ä¾èµ–å¤šä¸ª Koa ç”Ÿæ€åŒ…

**å‡çº§å»ºè®®**:
1. éªŒè¯ `@koa/router` 14.0.0 æ˜¯å¦æ”¯æŒ Koa 3ï¼ˆæ ¹æ®ç‰ˆæœ¬å·æ¨æµ‹åº”è¯¥æ”¯æŒï¼‰
2. æµ‹è¯• GraphQL è·¯ç”±åŠŸèƒ½
3. å¦‚æœ‰é—®é¢˜ï¼Œè€ƒè™‘å‡çº§ `koa-graphql` åˆ°æœ€æ–°ç‰ˆæœ¬

---

#### 3.2.4 koatty_container âœ… **æ— å½±å“**

**å½“å‰ç‰ˆæœ¬**: 1.17.0

**å½±å“è¯„ä¼°**:
- âœ… å®Œå…¨ç‹¬ç«‹çš„ IOC å®¹å™¨å®ç°
- âœ… ä¸ç›´æ¥ä¾èµ– Koa
- âœ… æ— éœ€ä¿®æ”¹

---

#### 3.2.5 koatty_exception âœ… **ä½é£é™©**

**å½“å‰ç‰ˆæœ¬**: ~1.8.0

**å½±å“è¯„ä¼°**:
- âœ… å¼‚å¸¸å¤„ç†é€»è¾‘ç‹¬ç«‹
- âš ï¸ å¯èƒ½ä½¿ç”¨ `ctx.throw()`ï¼Œä½†è¿™æ˜¯å‘åå…¼å®¹çš„
- â„¹ï¸ å»ºè®®æŸ¥çœ‹æ˜¯å¦å¯åˆ©ç”¨æ–°çš„é”™è¯¯å¤„ç†æ”¹è¿›

---

#### 3.2.6 koatty_trace âœ… **ä½é£é™©**

**å½“å‰ç‰ˆæœ¬**: ~1.16.0

**å½±å“è¯„ä¼°**:
- âœ… è¿½è¸ªå’Œæ—¥å¿—åŠŸèƒ½ç‹¬ç«‹
- âœ… åŸºäº AsyncLocalStorageï¼ˆä¸ Koa 3 çš„ currentContext ä¸€è‡´ï¼‰
- â„¹ï¸ å¯èƒ½ä» Koa 3 çš„ currentContext ä¸­å—ç›Š

---

## å››ã€è¯¦ç»†æ”¹é€ æ–¹æ¡ˆ

### 4.1 ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡å·¥ä½œï¼ˆé¢„è®¡ 1-2 å¤©ï¼‰

#### 4.1.1 ç¯å¢ƒå‡†å¤‡

```bash
# 1. æ£€æŸ¥ Node.js ç‰ˆæœ¬
node -v  # ç¡®ä¿ >= 18.0.0

# 2. åˆ›å»ºæµ‹è¯•åˆ†æ”¯
git checkout -b feat/koa3-upgrade
```

#### 4.1.2 ä¾èµ–ç‰ˆæœ¬è°ƒæŸ¥

åˆ›å»ºä¾èµ–å…¼å®¹æ€§æµ‹è¯•è„šæœ¬ï¼š

```javascript
// scripts/check-koa3-compatibility.js
const dependencies = {
  'koa': '^3.0.0',
  'koa-compose': '^4.1.0',
  '@koa/router': '^14.0.0',
  'koa-graphql': '^0.12.0'
};

// åœ¨æµ‹è¯•é¡¹ç›®ä¸­éªŒè¯è¿™äº›ä¾èµ–
```

---

### 4.2 ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŒ…å‡çº§ï¼ˆé¢„è®¡ 3-5 å¤©ï¼‰

#### 4.2.1 koatty ä¸»åŒ…

**package.json ä¿®æ”¹**:

```json
{
  "engines": {
    "node": ">=18.0.0"  // ä» >12.0.0 æ›´æ–°
  },
  "dependencies": {
    "koa": "^3.0.0",  // ä» ~2.16.2 æ›´æ–°
    "koatty_core": "~1.20.0",  // ç­‰å¾… koatty_core å‘å¸ƒ Koa 3 æ”¯æŒç‰ˆæœ¬
    // å…¶ä»–ä¾èµ–ä¿æŒä¸å˜
  },
  "devDependencies": {
    "@types/koa": "^2.15.0",  // ä» ^2.x.x æ›´æ–°åˆ°æ”¯æŒ Koa 3 çš„ç‰ˆæœ¬
    "@types/koa-compose": "^3.x.x"  // éªŒè¯ç‰ˆæœ¬
  }
}
```

**æ— éœ€ä»£ç ä¿®æ”¹** - Koatty ä¸»åŒ…åªæ˜¯ç»„åˆå…¶ä»–åŒ…ï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨ Koa APIã€‚

---

#### 4.2.2 koatty_core åŒ…

**package.json ä¿®æ”¹**:

```json
{
  "version": "1.20.0",  // å‡çº§ç‰ˆæœ¬
  "dependencies": {
    "koa-compose": "^4.1.0",  // éªŒè¯å…¼å®¹æ€§ï¼Œå¿…è¦æ—¶å‡çº§
    // å…¶ä»–ä¾èµ–ä¸å˜
  },
  "peerDependencies": {
    "koa": "^2.x.x || ^3.x.x"  // å…¼å®¹ Koa 2 å’Œ 3
  },
  "devDependencies": {
    "koa": "^3.x.x",
    "@types/koa": "^2.15.0"
  }
}
```

**ä»£ç æ£€æŸ¥é‡ç‚¹**:

```typescript
// src/Application.ts - æ— éœ€ä¿®æ”¹ï¼Œä½†éœ€æµ‹è¯•

// é‡ç‚¹æµ‹è¯•ä»¥ä¸‹æ–¹æ³•ï¼š
// 1. createContext() - ç¡®ä¿ context åˆ›å»ºæ­£å¸¸
// 2. callback() - ç¡®ä¿ middleware ç»„åˆæ­£å¸¸
// 3. use() - ç¡®ä¿ middleware æ³¨å†Œæ­£å¸¸
```

**å…¼å®¹æ€§å¤„ç†**ï¼ˆå¦‚æœ koa-compose æœ‰é—®é¢˜ï¼‰:

```typescript
// å¦‚æœ koa-compose ä¸å…¼å®¹ï¼Œå¯ä»¥è‡ªè¡Œå®ç°æˆ–ä½¿ç”¨ Koa 3 å†…ç½®çš„ compose
import koaCompose from "koa-compose";

// æˆ–è€…ä» Koa 3 å†…éƒ¨å¯¼å…¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
// import { compose } from "koa";
```

---

#### 4.2.3 koatty_router åŒ…

**package.json ä¿®æ”¹**:

```json
{
  "version": "1.21.0",
  "dependencies": {
    "@koa/router": "^14.0.0",  // éªŒè¯ Koa 3 å…¼å®¹æ€§
    "koa-compose": "^4.1.0",
    "koa-graphql": "^0.13.0",  // å¯èƒ½éœ€è¦å‡çº§
    "koatty_core": "^1.20.0"  // ç­‰å¾… Koa 3 æ”¯æŒç‰ˆæœ¬
  }
}
```

**å…¼å®¹æ€§éªŒè¯**:

```bash
# åœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯ @koa/router
npm install @koa/router@14.0.0 koa@3.0.0
npm test
```

**å¯èƒ½çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**:

1. **å¦‚æœ @koa/router ä¸å…¼å®¹**:
   ```bash
   # æŸ¥æ‰¾æœ€æ–°ç‰ˆæœ¬
   npm info @koa/router versions
   npm install @koa/router@latest
   ```

2. **å¦‚æœ koa-graphql ä¸å…¼å®¹**:
   ```bash
   # è€ƒè™‘å‡çº§æˆ–æ›¿æ¢
   npm install koa-graphql@latest
   # æˆ–ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆå¦‚ graphql-http
   ```

---

#### 4.2.4 koatty_serve åŒ…

**package.json ä¿®æ”¹**:

```json
{
  "version": "2.10.0",
  "dependencies": {
    "koatty_core": "^1.20.0"  // æ›´æ–°åˆ°æ”¯æŒ Koa 3 çš„ç‰ˆæœ¬
  }
}
```

**æµ‹è¯•é‡ç‚¹**:

```typescript
// æµ‹è¯•æ‰€æœ‰åè®®æœåŠ¡å™¨
// 1. HTTP/HTTPS æœåŠ¡å™¨
// 2. HTTP2 æœåŠ¡å™¨
// 3. gRPC æœåŠ¡å™¨
// 4. WebSocket æœåŠ¡å™¨
// 5. HTTP3/QUIC æœåŠ¡å™¨ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
```

---

### 4.3 ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•ä¸éªŒè¯ï¼ˆé¢„è®¡ 3-5 å¤©ï¼‰

#### 4.3.1 å•å…ƒæµ‹è¯•

```bash
# 1. koatty ä¸»åŒ…æµ‹è¯•
cd /home/richen/workspace/nodejs/koatty
npm test

# 2. koatty_core æµ‹è¯•
cd /home/richen/workspace/nodejs/koatty_core
npm test

# 3. koatty_serve æµ‹è¯•
cd /home/richen/workspace/nodejs/koatty_serve
npm test

# 4. koatty_router æµ‹è¯•
cd /home/richen/workspace/nodejs/koatty_router
npm test
```

#### 4.3.2 é›†æˆæµ‹è¯•

åˆ›å»ºå®Œæ•´çš„æµ‹è¯•åº”ç”¨ï¼š

```typescript
// test-app/src/App.ts
import { Bootstrap, Koatty } from "koatty";
import * as path from 'path';

@Bootstrap()
export class TestApp extends Koatty {
  public init() {
    this.appDebug = true;
    this.rootPath = path.dirname(__dirname);
  }
}
```

æµ‹è¯•åœºæ™¯ï¼š
1. âœ… åŸºæœ¬ HTTP è¯·æ±‚/å“åº”
2. âœ… ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº
3. âœ… é”™è¯¯å¤„ç†
4. âœ… å¼‚æ­¥æ“ä½œ
5. âœ… å¤šåè®®æ”¯æŒï¼ˆHTTP, gRPC, WebSocketï¼‰
6. âœ… IOC å®¹å™¨æ³¨å…¥
7. âœ… è·¯ç”±åŠŸèƒ½
8. âœ… AOP åˆ‡é¢
9. âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•

#### 4.3.3 å…¼å®¹æ€§æµ‹è¯•çŸ©é˜µ

| æµ‹è¯•é¡¹        | Koa 2.16.2 | Koa 3.0.0 | çŠ¶æ€ |
| ------------- | ---------- | --------- | ---- |
| HTTP Server   | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| HTTPS Server  | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| HTTP2 Server  | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| gRPC Server   | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| WebSocket     | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| Middleware    | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| Router        | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| Context       | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| IOC Container | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| AOP           | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| Exception     | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |
| Trace         | âœ…          | ğŸ” å¾…æµ‹è¯•  |      |

---

### 4.4 ç¬¬å››é˜¶æ®µï¼šæ–‡æ¡£ä¸å‘å¸ƒï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰

#### 4.4.1 æ›´æ–°æ–‡æ¡£

1. **README.md** - æ›´æ–°ç‰ˆæœ¬è¦æ±‚
   ```markdown
   ## Requirements
   - Node.js >= 18.0.0
   - Koa >= 3.0.0
   ```

2. **CHANGELOG.md** - æ·»åŠ å‡çº§è¯´æ˜
   ```markdown
   ## [3.14.0] - 2025-XX-XX
   
   ### âš ï¸ Breaking Changes
   - **Upgraded to Koa 3.0**: Requires Node.js >= 18.0.0
   - Updated all core dependencies to support Koa 3.0
   
   ### ğŸ“¦ Dependencies
   - `koa`: 2.16.2 â†’ 3.0.0
   - `koatty_core`: 1.19.0-6 â†’ 1.20.0
   - `koatty_serve`: 2.9.0-15 â†’ 2.10.0
   - `koatty_router`: 1.20.0-8 â†’ 1.21.0
   
   ### âœ¨ Enhancements
   - Better TypeScript type definitions
   - Performance improvements from Koa 3.0
   - Support for `app.currentContext` API
   
   ### ğŸ“– Migration Guide
   See [KOA3_MIGRATION_GUIDE.md](./KOA3_MIGRATION_GUIDE.md)
   ```

3. **åˆ›å»ºè¿ç§»æŒ‡å—** - `KOA3_MIGRATION_GUIDE.md`

#### 4.4.2 ç‰ˆæœ¬å‘å¸ƒç­–ç•¥

```bash
# 1. å…ˆå‘å¸ƒ koatty_core
cd koatty_core
npm version minor  # 1.19.0-6 â†’ 1.20.0
npm publish

# 2. å‘å¸ƒ koatty_serve
cd koatty_serve
npm version minor  # 2.9.0-15 â†’ 2.10.0
npm publish

# 3. å‘å¸ƒ koatty_router
cd koatty_router
npm version minor  # 1.20.0-8 â†’ 1.21.0
npm publish

# 4. æœ€åå‘å¸ƒ koatty
cd koatty
npm version minor  # 3.13.2 â†’ 3.14.0
npm publish
```

---

## äº”ã€é£é™©è¯„ä¼°ä¸ç¼“è§£æªæ–½

### 5.1 é«˜é£é™©é¡¹

| é£é™©é¡¹                 | é£é™©ç­‰çº§ | å½±å“èŒƒå›´                   | ç¼“è§£æªæ–½                                                |
| ---------------------- | -------- | -------------------------- | ------------------------------------------------------- |
| koa-compose ä¸å…¼å®¹     | ğŸŸ¡ ä¸­     | koatty_core, koatty_router | 1. æµ‹è¯•éªŒè¯<br>2. å‡†å¤‡æ›¿ä»£æ–¹æ¡ˆ<br>3. å¯è‡ªè¡Œå®ç° compose |
| @koa/router ä¸å…¼å®¹     | ğŸŸ¡ ä¸­     | koatty_router              | 1. å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬<br>2. è”ç³»ç»´æŠ¤è€…<br>3. Fork å¹¶ä¿®å¤    |
| ç”¨æˆ·ä»£ç ä½¿ç”¨ Generator | ğŸŸ¢ ä½     | ç”¨æˆ·åº”ç”¨                   | æä¾›è¿ç§»æŒ‡å—å’Œå·¥å…·                                      |

### 5.2 ç¼“è§£æªæ–½

#### 5.2.1 å‘åå…¼å®¹ç­–ç•¥

```json
// åœ¨ koatty_core ä¸­æ”¯æŒ Koa 2 å’Œ 3
{
  "peerDependencies": {
    "koa": "^2.x.x || ^3.x.x"
  }
}
```

#### 5.2.2 æ¸è¿›å¼å‡çº§è·¯å¾„

æä¾›ä¸¤ä¸ªåˆ†æ”¯ï¼š
- `v3.13.x` - ç»§ç»­æ”¯æŒ Koa 2
- `v3.14.x` - æ”¯æŒ Koa 3

#### 5.2.3 å›æ»šæ–¹æ¡ˆ

```json
// å¦‚æœå‡çº§é‡åˆ°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»š
{
  "dependencies": {
    "koa": "~2.16.2",
    "koatty_core": "~1.19.0-6",
    "koatty_serve": "~2.9.0-15",
    "koatty_router": "1.20.0-8"
  }
}
```

---

## å…­ã€ç”¨æˆ·è¿ç§»æŒ‡å—æ¦‚è¦

### 6.1 å¿…é¡»ä¿®æ”¹çš„é¡¹

1. **å‡çº§ Node.js**:
   ```bash
   node -v  # å¿…é¡» >= 18.0.0
   ```

2. **æ›´æ–°ä¾èµ–**:
   ```bash
   npm install koatty@^3.14.0
   # æˆ–
   yarn upgrade koatty@^3.14.0
   ```

### 6.2 å¯èƒ½éœ€è¦ä¿®æ”¹çš„é¡¹

1. **å¦‚æœä½¿ç”¨äº† Generator**ï¼ˆæ¡†æ¶è‡ªèº«æ²¡æœ‰ï¼Œä½†ç”¨æˆ·ä»£ç å¯èƒ½æœ‰ï¼‰:
   ```typescript
   // âŒ æ—§ä»£ç ï¼ˆKoa 2ï¼‰
   app.use(function* (next) {
     yield next;
   });

   // âœ… æ–°ä»£ç ï¼ˆKoa 3ï¼‰
   app.use(async (ctx, next) => {
     await next();
   });
   ```

2. **å¦‚æœä½¿ç”¨äº† ctx.throw()**ï¼ˆæ ¼å¼å¯èƒ½å˜åŒ–ï¼‰:
   ```typescript
   // âš ï¸ æ³¨æ„ï¼šå¯èƒ½éœ€è¦è°ƒæ•´é”™è¯¯å¤„ç†ä»£ç 
   // Koa 3 ä½¿ç”¨ http-errors v2
   ```

3. **å¦‚æœä¾èµ–ç‰¹å®š Node.js ç‰ˆæœ¬ç‰¹æ€§**:
   - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† Node.js 18 ä¸­ç§»é™¤æˆ–å˜æ›´çš„ API

### 6.3 æ— éœ€ä¿®æ”¹çš„é¡¹

- âœ… æ‰€æœ‰ä½¿ç”¨ async/await çš„ä»£ç 
- âœ… æ ‡å‡†çš„ Koatty è£…é¥°å™¨ï¼ˆ@Controller, @Service, ç­‰ï¼‰
- âœ… ä¸­é—´ä»¶ï¼ˆåªè¦ä½¿ç”¨ async/awaitï¼‰
- âœ… è·¯ç”±é…ç½®
- âœ… IOC å®¹å™¨ä½¿ç”¨
- âœ… AOP åˆ‡é¢

---

## ä¸ƒã€æ—¶é—´è¡¨ä¸é‡Œç¨‹ç¢‘

### 7.1 è¯¦ç»†æ—¶é—´è§„åˆ’

| é˜¶æ®µ      | ä»»åŠ¡       | æ—¶é—´       | è´Ÿè´£äºº     | äº¤ä»˜ç‰©     |
| --------- | ---------- | ---------- | ---------- | ---------- |
| **é˜¶æ®µ1** | ä¾èµ–è°ƒç ”   | 1-2å¤©      | å¼€å‘å›¢é˜Ÿ   | å…¼å®¹æ€§æŠ¥å‘Š |
| **é˜¶æ®µ2** | æ ¸å¿ƒåŒ…å‡çº§ | 3-5å¤©      | æ ¸å¿ƒå¼€å‘è€… | æ›´æ–°çš„åŒ…   |
| **é˜¶æ®µ3** | æµ‹è¯•éªŒè¯   | 3-5å¤©      | QAå›¢é˜Ÿ     | æµ‹è¯•æŠ¥å‘Š   |
| **é˜¶æ®µ4** | æ–‡æ¡£ä¸å‘å¸ƒ | 2-3å¤©      | æ–‡æ¡£å›¢é˜Ÿ   | æ–‡æ¡£+å‘å¸ƒ  |
| **æ€»è®¡**  |            | **9-15å¤©** |            | å®Œæ•´å‡çº§   |

### 7.2 å…³é”®é‡Œç¨‹ç¢‘

- âœ… **M1**: å®Œæˆå…¼å®¹æ€§åˆ†æï¼ˆå½“å‰æ–‡æ¡£ï¼‰
- ğŸ”² **M2**: éªŒè¯æ‰€æœ‰ç¬¬ä¸‰æ–¹ä¾èµ–å…¼å®¹æ€§
- ğŸ”² **M3**: koatty_core å‡çº§å®Œæˆå¹¶é€šè¿‡æµ‹è¯•
- ğŸ”² **M4**: koatty_serve å’Œ koatty_router å‡çº§å®Œæˆ
- ğŸ”² **M5**: koatty ä¸»åŒ…å‡çº§å®Œæˆ
- ğŸ”² **M6**: å®Œæ•´æµ‹è¯•å¥—ä»¶é€šè¿‡
- ğŸ”² **M7**: æ–‡æ¡£æ›´æ–°å®Œæˆ
- ğŸ”² **M8**: æ­£å¼å‘å¸ƒ v3.14.0

---

## å…«ã€åç»­ä¼˜åŒ–å»ºè®®

### 8.1 åˆ©ç”¨ Koa 3 æ–°ç‰¹æ€§

1. **ä½¿ç”¨ currentContext API**:
   ```typescript
   // åœ¨ä»»ä½•åœ°æ–¹è·å–å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡
   const ctx = app.currentContext;
   ```

2. **æ€§èƒ½ä¼˜åŒ–**:
   - åˆ©ç”¨ Koa 3 çš„å†…éƒ¨æ€§èƒ½æ”¹è¿›
   - è¯„ä¼°æ˜¯å¦å¯ä»¥ç§»é™¤ä¸€äº›æ€§èƒ½è¡¥ä¸

3. **ç±»å‹å®šä¹‰æ”¹è¿›**:
   - ä½¿ç”¨ Koa 3 æ”¹è¿›çš„ TypeScript ç±»å‹
   - å‡å°‘ç±»å‹æ–­è¨€

### 8.2 é•¿æœŸç»´æŠ¤ç­–ç•¥

1. **ç‰ˆæœ¬æ”¯æŒ**:
   - v3.13.x (Koa 2): ç»´æŠ¤ 6-12 ä¸ªæœˆ
   - v3.14.x (Koa 3): ä¸»è¦å¼€å‘åˆ†æ”¯

2. **å¼ƒç”¨æ—¶é—´è¡¨**:
   - 2025 Q2: å‘å¸ƒ Koa 3 æ”¯æŒ
   - 2025 Q3: é¼“åŠ±ç”¨æˆ·å‡çº§
   - 2025 Q4: Koa 2 æ”¯æŒè¿›å…¥ç»´æŠ¤æ¨¡å¼
   - 2026 Q2: åœæ­¢ Koa 2 æ”¯æŒ

---

## ä¹ã€ç»“è®º

### 9.1 å¯è¡Œæ€§è¯„ä¼°

**âœ… å‡çº§åˆ° Koa 3.0 æ˜¯å®Œå…¨å¯è¡Œçš„**

ç†ç”±ï¼š
1. âœ… Koatty æ¡†æ¶å·²ç»ä½¿ç”¨ç°ä»£åŒ–çš„ async/await è¯­æ³•
2. âœ… æ²¡æœ‰ä½¿ç”¨ Koa 3.0 ä¸­ç§»é™¤çš„ API
3. âœ… æ ¸å¿ƒæ¶æ„è®¾è®¡è‰¯å¥½ï¼Œä¾èµ–å…³ç³»æ¸…æ™°
4. âœ… ä¸»è¦é£é™©é›†ä¸­åœ¨ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¯æ§
5. âœ… æœ‰æ˜ç¡®çš„æµ‹è¯•å’Œå›æ»šæ–¹æ¡ˆ

### 9.2 æ¨èè¡ŒåŠ¨

**å»ºè®®ç«‹å³å¯åŠ¨å‡çº§å·¥ä½œ**ï¼ŒåŸå› ï¼š

1. **æŠ€æœ¯å€ºåŠ¡æœ€å°åŒ–**: ç°åœ¨å‡çº§æ¯”ç­‰å¾…æ›´å®¹æ˜“
2. **æ€§èƒ½æ”¶ç›Š**: Koa 3.0 å¸¦æ¥ 5-10% æ€§èƒ½æå‡
3. **ç”Ÿæ€åŒæ­¥**: ä¿æŒä¸ Koa ç”Ÿæ€åŒæ­¥
4. **é•¿æœŸç»´æŠ¤**: Node.js 18 LTS æ”¯æŒåˆ° 2025 å¹´ 4 æœˆ

### 9.3 é¢„æœŸæ”¶ç›Š

- ğŸš€ **æ€§èƒ½æå‡**: 5-10% æ•´ä½“æ€§èƒ½æ”¹è¿›
- ğŸ“¦ **æ›´å¥½çš„ç±»å‹æ”¯æŒ**: æ”¹è¿›çš„ TypeScript å®šä¹‰
- ğŸ”§ **æ–°ç‰¹æ€§**: å¯ä½¿ç”¨ currentContext ç­‰æ–° API
- ğŸ›¡ï¸ **å®‰å…¨æ€§**: è·å¾—æœ€æ–°çš„å®‰å…¨æ›´æ–°
- ğŸŒ **ç”Ÿæ€ç³»ç»Ÿ**: ä¿æŒä¸ Koa ç”Ÿæ€ç³»ç»ŸåŒæ­¥

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [Koa 3.0 Changelog](https://github.com/koajs/koa/releases/tag/3.0.0)
- [Koa 3.0 Migration Guide](https://github.com/koajs/koa/blob/master/docs/migration.md)
- [Node.js 18 Documentation](https://nodejs.org/docs/latest-v18.x/api/)
- [@koa/router Documentation](https://github.com/koajs/router)
- [koa-compose Documentation](https://github.com/koajs/compose)

### B. è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **æŠ€æœ¯æ”¯æŒ**: richenlin@gmail.com
- **GitHub Issues**: https://github.com/thinkkoa/koatty/issues
- **è®¨è®ºåŒº**: https://github.com/Koatty/koatty/discussions

### C. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ       | ä½œè€…            | å˜æ›´     |
| ---- | ---------- | --------------- | -------- |
| 1.0  | 2025-10-22 | ZhiSi Architect | åˆå§‹ç‰ˆæœ¬ |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ
**æœ€åæ›´æ–°**: 2025-10-22
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸

